import { defineEventHandler } from "h3";
import { queryCollection } from "@nuxt/content/server";
import manifest from "#content/manifest";
export default defineEventHandler(async (e) => {
  const collections = [];
  for (const collection in manifest) {
    if (manifest[collection].fields.sitemap) {
      collections.push(collection);
    }
  }
  const contentList = [];
  for (const collection of collections) {
    contentList.push(
      queryCollection(e, collection).select("path", "sitemap").where("path", "IS NOT NULL").where("sitemap", "IS NOT NULL").all()
    );
  }
  const results = await Promise.all(contentList);
  return results.flatMap((c) => {
    return c.filter((c2) => c2.sitemap !== false && c2.path).flatMap((c2) => ({
      loc: c2.path,
      ...c2.sitemap || {}
    }));
  }).filter(Boolean);
});
